name: Reusable Docker Blue-Green Deployment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment'
        required: false
        default: 'production'
        type: string
      container_prefix:
        description: 'Container name prefix'
        required: true
        type: string
      container_port:
        description: 'Container port'
        required: false
        default: '3000'
        type: string
      health_check_timeout:
        description: 'Health check timeout in seconds'
        required: false
        default: '300'
        type: string
      notification_enabled:
        description: 'Enable deployment notifications'
        required: false
        default: true
        type: boolean
    secrets:
      CLOUDFLARE_TUNNEL_TOKEN:
        description: 'Cloudflare tunnel token'
        required: true
      EMAIL_USER:
        description: 'Email user for notifications'
        required: false
      EMAIL_PASS:
        description: 'Email password for notifications'
        required: false

jobs:
  deploy:
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    concurrency:
      group: deploy-${{ inputs.environment }}
      cancel-in-progress: false
    
    env:
      CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
      EMAIL_USER: ${{ secrets.EMAIL_USER }}
      EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      CONTAINER_PREFIX: ${{ inputs.container_prefix }}
      CONTAINER_PORT: ${{ inputs.container_port }}
    
    outputs:
      deployment_status: ${{ steps.deployment_result.outputs.status }}
      deployed_slot: ${{ steps.determine_slots.outputs.deploy_slot }}
      deployment_time: ${{ steps.deployment_result.outputs.time }}
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üê≥ Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        install: true
    
    - name: üîß Setup Docker Compose Cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.docker/cli-plugins/docker-compose
          /tmp/.buildx-cache
        key: ${{ runner.os }}-docker-${{ hashFiles('**/docker-compose.yml') }}
        restore-keys: |
          ${{ runner.os }}-docker-
    
    - name: üìã Pre-deployment Validation
      id: validation
      run: |
        echo "üîç Validating deployment environment..."
        
        # Check if required files exist
        if [ ! -f "docker-compose.yml" ]; then
          echo "‚ùå docker-compose.yml not found!"
          exit 1
        fi
        
        # Check if Docker daemon is running
        if ! docker info >/dev/null 2>&1; then
          echo "‚ùå Docker daemon is not running!"
          exit 1
        fi
        
        echo "‚úÖ Pre-deployment validation passed"
        echo "validated=true" >> $GITHUB_OUTPUT
    
    - name: üßπ Clean Up Target Container Only (Zero Downtime)
      run: |
        echo "üßπ Preparing deployment..."
        
        # Single container deployment - no blue-green needed
        CONTAINER_NAME="${{ env.CONTAINER_PREFIX }}"
        
        echo "üéØ Target container: ${CONTAINER_NAME}"
        
        # Remove the existing container if it exists
        echo "üõë Removing existing container: ${CONTAINER_NAME}"
        docker rm -f "${CONTAINER_NAME}" 2>/dev/null || true
        
        # REMOVED: Dangerous container prune command that was removing live containers
        # We'll only remove what we explicitly want to remove
        
        echo "‚úÖ Container cleanup completed"
    
    - name: üîß Verify Configuration
      run: |
        echo "‚úÖ Single container deployment configuration verified"
    
    - name: üåê Ensure Core Infrastructure
      run: |
        echo "üöÄ Ensuring nginx and cloudflared are running..."
        docker compose up -d --remove-orphans nginx
        
        # Enhanced health check with timeout
        timeout_seconds=60
        elapsed=0
        
        while [ $elapsed -lt $timeout_seconds ]; do
          HEALTH_STATUS=$(docker inspect --format '{{.State.Health.Status}}' portfolio-nginx 2>/dev/null || echo "starting")
          if [ "${HEALTH_STATUS}" == "healthy" ]; then
            echo "‚úÖ Nginx is healthy!"
            docker compose up -d --remove-orphans cloudflared
            break
          fi
          echo "‚è≥ Waiting for Nginx to be healthy... (Status: ${HEALTH_STATUS})"
          sleep 6
          elapsed=$((elapsed + 6))
        done
        
        if [ $elapsed -ge $timeout_seconds ]; then
          echo "‚ùå Nginx failed to start within timeout. Check logs."
          docker compose logs nginx
          exit 1
        fi
    
    - name: üéØ Confirm Deployment Target
      id: determine_slots
      run: |
        # Single container deployment
        echo "üéØ Deploying to: ${{ env.CONTAINER_PREFIX }}"
        
        # Set container name for consistency with existing code
        echo "DEPLOY_SLOT=portfolio" >> $GITHUB_ENV
        echo "live_slot=portfolio" >> $GITHUB_OUTPUT
        echo "deploy_slot=portfolio" >> $GITHUB_OUTPUT
    
    - name: üîç Validate Current Environment
      run: |
        CONTAINER_NAME="${{ env.CONTAINER_PREFIX }}"
        echo "üîç Validating current environment: ${CONTAINER_NAME}"
        
        # Check if container exists and is running
        if docker ps -q -f name="${CONTAINER_NAME}" | grep -q .; then
          # Container is running, check health status
          HEALTH_STATUS=$(docker inspect --format '{{.State.Health.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo "none")
          if [ "${HEALTH_STATUS}" == "healthy" ]; then
            echo "‚úÖ Current container is healthy and serving traffic!"
          else
            echo "‚ö†Ô∏è Current container is running but not healthy (Status: ${HEALTH_STATUS})"
            echo "üîÑ Will replace with new deployment..."
          fi
        else
          echo "‚ÑπÔ∏è No existing container found - will deploy new one"
        fi
    
    - name: üî® Build and Deploy New Version
      run: |
        CONTAINER_NAME="${{ env.CONTAINER_PREFIX }}"
        echo "üöÄ Building and deploying ${CONTAINER_NAME}..."
        
        # Build with cache
        DOCKER_BUILDKIT=1 docker compose build --build-arg BUILDKIT_INLINE_CACHE=1 portfolio
        
        # Deploy the new version with orphan removal
        docker compose up -d --force-recreate --remove-orphans portfolio
        
        echo "‚úÖ New version deployed to ${CONTAINER_NAME}"
    
    - name: üîç Wait for New Environment Health
      run: |
        CONTAINER_NAME="${{ env.CONTAINER_PREFIX }}"
        timeout_seconds=${{ inputs.health_check_timeout }}
        elapsed=0
        
        echo "üîç Waiting for ${CONTAINER_NAME} to become healthy..."
        
        while [ $elapsed -lt $timeout_seconds ]; do
          HEALTH_STATUS=$(docker inspect --format '{{.State.Health.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo "starting")
          if [ "${HEALTH_STATUS}" == "healthy" ]; then
            echo "‚úÖ ${CONTAINER_NAME} is healthy!"
            break
          fi
          echo "‚è≥ Waiting... (Status: ${HEALTH_STATUS}) - ${elapsed}s elapsed"
          sleep 10
          elapsed=$((elapsed + 10))
        done
        
        if [ $elapsed -ge $timeout_seconds ]; then
          echo "‚ùå ${CONTAINER_NAME} failed to become healthy. Aborting."
          docker compose logs portfolio
          exit 1
        fi
    
    - name: üîÑ Verify Deployment Success
      run: |
        echo "üîÑ Verifying deployment success..."
        
        # Verify the new environment is healthy
        CONTAINER_NAME="${{ env.CONTAINER_PREFIX }}"
        HEALTH_STATUS=$(docker inspect --format '{{.State.Health.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo "none")
        
        if [ "${HEALTH_STATUS}" == "healthy" ]; then
          echo "‚úÖ Deployment successful! New environment is healthy."
        else
          echo "‚ùå New environment is not healthy after deployment."
          echo "‚ùå Deployment failed"
          exit 1
        fi
    
    - name: üßπ Clean Up Old Images
      run: |
        echo "üßπ Cleaning up old images..."
        
        # Clean up old images (keep last 2 versions)
        docker image prune -f --filter "until=72h" || true
    
    - name: üîç Final Deployment Validation
      run: |
        echo "üîç Performing final deployment validation..."
        
        # Verify the new environment is still healthy
        CONTAINER_NAME="${{ env.CONTAINER_PREFIX }}"
        HEALTH_STATUS=$(docker inspect --format '{{.State.Health.Status}}' ${CONTAINER_NAME} 2>/dev/null || echo "none")
        
        if [ "${HEALTH_STATUS}" != "healthy" ]; then
          echo "‚ùå Final validation failed - new environment is not healthy"
          exit 1
        fi
        
        # Verify nginx is serving traffic correctly
        NGINX_STATUS=$(docker inspect --format '{{.State.Health.Status}}' portfolio-nginx 2>/dev/null || echo "none")
        if [ "${NGINX_STATUS}" != "healthy" ]; then
          echo "‚ùå Final validation failed - nginx is not healthy"
          exit 1
        fi
        
        echo "‚úÖ Final validation passed - deployment successful!"
    
    - name: üìä Deployment Summary
      id: deployment_result
      run: |
        echo "üéâ Deployment complete!"
        echo "üìà Deployment Summary:"
        echo "  ‚Ä¢ Environment: ${{ inputs.environment }}"
        echo "  ‚Ä¢ Container: ${{ env.CONTAINER_PREFIX }}"
        echo "  ‚Ä¢ Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
        
        docker compose ps
        
        echo "status=success" >> $GITHUB_OUTPUT
        echo "time=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_OUTPUT
    
    - name: üìß Send Notification
      if: ${{ inputs.notification_enabled && always() }}
      run: |
        if [ "${{ steps.deployment_result.outputs.status }}" = "success" ]; then
          STATUS_EMOJI="‚úÖ"
          STATUS_TEXT="SUCCESS"
        else
          STATUS_EMOJI="‚ùå"
          STATUS_TEXT="FAILED"
        fi
        
        echo "${STATUS_EMOJI} Deployment ${STATUS_TEXT} for ${{ inputs.environment }}"
        echo "Container: ${{ env.CONTAINER_PREFIX }}"
        echo "Time: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
